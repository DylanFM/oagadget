<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Open Australia">
    <Require feature="opensocial-0.8" />
    <Require feature="setprefs" />
  </ModulePrefs>
  <UserPref name="postcode" display_name="Postcode" required="true" />
  <Content type="html" view="nav">
    <![CDATA[

    <div id="app">
    
      <div id="prefs"></div>
    
    </div>

    <script type="text/javascript" src="http://www.google.com/jsapi" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
      google.load("jquery", "1.3.2");
    </script>
		<script type="text/javascript" charset="utf-8">
			(function($) {

			  $(document).ready(function() {

          var showPrefs = function() {
            // Show a line of info for the user
            if (!postcode || postcode === '') {
              $("#prefs").html("<a href=\"#\" class=\"show-pref-form\" title=\"\">Set postcode</a>");
            } else {
              $("#prefs").html("Your postcode: " + postcode + " <a href=\"#\" class=\"show-pref-form\" title=\"\">Change</a>");
            }
            $(".show-pref-form").click(addSetPrefForm);
          };

  			  var addSetPrefForm = function() {
  			    if ($("#set-pref-form") || $("#set-pref-form").length > 0) {
  			      return false;
  			    }
  			    $(app).append("<div id=\"set-pref-form\"><p>Set your postcode:</p><input type=\"text\" name=\"postcode\" id=\"postcode\" size=\"6\" /><input type=\"submit\" name=\"submit\" value=\"Save\" id=\"save\" /><a href=\"#\" title=\"Close the form\" id=\"hide-set-pref-form\">[x]</a></div>");
            // Close link
            $("#hide-set-pref-form").click(hideSetPrefForm);;
            // Add save functionality to button
            $("#save").click(function(event) {
              // Save the postcode
              postcode = $("#postcode").val();
              prefs.set("postcode", postcode);
              showPrefs();
              showRepresentative();
              hideSetPrefForm();
              return false;
            });
  			  };

  			  var hideSetPrefForm = function() {
  			    $("#set-pref-form").remove();
            return false;
  			  };

			    var showRepresentative = function() {
			      var url = "http://www.openaustralia.org/api/getRepresentatives?output=js&key=" + key;
			      if (!postcode || postcode === '') {
              // We need a postcode for this
			        return false;
			      }
            // Append postcode to url
            url += "&postcode=" + postcode;
            // Call the Open Australia API to get the representative for the postcode
            gadgets.io.makeRequest(url, function(data) {
              addRepresentativeInfo(gadgets.json.parse(data.text)[0]);
            });
            return true;
			    };
			    
			    var addRepresentativeInfo = function(rep) {
			      var name;
			      if (rep) {
			        name = rep.first_name + " " + rep.last_name;
			        // Remove existing message(s)
    			    $("p.message").remove();
              // Add new message
    			    $(app).append("<p class=\"message\">Your representative is " + name + ".</p>");
			      }
			      return false;
			    };
			    
			    // Application code
          var prefs = new gadgets.Prefs(),
              app = $("#app"),
              postcode = prefs.getString("postcode"),
              content,
              key = "Dyx3pGEa5rtRGKL6LXGCgPWr";
              
          showPrefs();
              
          if (postcode || postcode === '') {
            // If there isn't a postcode set, provide a way to set it
            addSetPrefForm();
          } else {
            // If there is a postcode set, use the Open Australia API to get their rep
            showRepresentative();
          }
			   
			  });
			  
			})(jQuery);
		</script>

    ]]>
  </Content>
</Module>