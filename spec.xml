<?xml version="1.0" encoding="UTF-8" ?>
<Module>
  <ModulePrefs title="Open Australia">
    <Require feature="opensocial-0.8" />
    <Require feature="setprefs" />
  </ModulePrefs>
  <UserPref name="postcode" display_name="Postcode" required="true" />
  <Content type="html" view="nav">
    <![CDATA[

    <div id="app">
    
    </div>

    <script type="text/javascript" src="http://www.google.com/jsapi" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
      google.load("jquery", "1.3.2");
    </script>
		<script type="text/javascript" charset="utf-8">
			(function($) {
			  
			  // Application code
        var prefs = new gadgets.Prefs(),
            app = $("#app"),
            postcode = prefs.getString("postcode"),
            content;

        console.log(postcode);

			  var showPostcode = function() {
			    $(app).append("<p>Your postcode is " + postcode + ". <a href=\"#\" title=\"Change preferences\" id=\"show-pref-form\">Change</a></p>");
			    $("#show-pref-form").click(addSetPrefForm);
			  };
			  
			  var addSetPrefForm = function() {
			    $(app).append("<div id=\"set-pref-form\"><p>Set your postcode:</p><input type=\"text\" name=\"postcode\" id=\"postcode\" size=\"6\" /><input type=\"submit\" name=\"submit\" value=\"Save\" id=\"save\" /><a href=\"#\" title=\"Close the form\" id=\"hide-set-pref-form\">[x]</a></div>");
          // Close link
          $("#hide-set-pref-form").click(hideSetPrefForm);;
          // Add save functionality to button
          $("#save").click(function(event) {
            // Save the postcode
            postcode = $("#postcode").val();
            prefs.set("postcode", postcode);
            showPostcode();
            hideSetPrefForm();
            return false;
          });
			  };
			  
			  var hideSetPrefForm = function() {
			    $("#set-pref-form").remove();
          return false;
			  };

        if (!postcode || postcode === '') {
          // If there isn't a postcode set, provide a way to set it
          addSetPrefForm();
        } else {
          // If there is a postcode set, use the Open Australia API to get their rep
          showPostcode();
        }
			  
			})(jQuery);
		</script>

    ]]>
  </Content>
</Module>